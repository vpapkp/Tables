<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplication Test Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 32rem;
            padding: 2.5rem;
            text-align: center;
        }
        .display-box {
            background-color: #f1f5f9;
            border-radius: 1rem;
            padding: 1.5rem;
            min-height: 7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            font-weight: 800;
            color: #0f172a;
            border: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .input-box {
            font-size: 3.5rem;
            font-weight: 800;
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            border-radius: 1rem;
            border: 3px solid #cbd5e1;
            color: #4f46e5;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-box:focus {
            border-color: #6366f1;
        }
        .input-box.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .input-box.wrong {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .btn {
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .score-pill {
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        #timer-bar {
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        #timer-fill {
            height: 100%;
            background-color: #6366f1;
            width: 100%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Math Master</h1>
            <p class="text-slate-500 mb-6" id="header-subtitle">Multiplication Test Master</p>

            <!-- Configuration Screen -->
            <div id="config-screen">
                <div class="space-y-6 text-left">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Select Table Range</label>
                        <div class="flex items-center space-x-3">
                            <select id="start-table" class="bg-white border border-slate-300 rounded-lg p-2 flex-1"></select>
                            <span class="text-slate-400 font-bold">to</span>
                            <select id="end-table" class="bg-white border border-slate-300 rounded-lg p-2 flex-1"></select>
                        </div>
                    </div>
                </div>
                <button id="btn-start" class="btn btn-primary w-full mt-8 text-lg shadow-lg">Start Test</button>
            </div>

            <!-- Test Screen -->
            <div id="test-screen" class="hidden">
                <div class="scoreboard">
                    <div class="score-pill bg-green-100 text-green-700">Correct: <span id="score-correct">0</span></div>
                    <div class="score-pill bg-red-100 text-red-700">Wrong: <span id="score-wrong">0</span></div>
                    <div class="score-pill bg-slate-100 text-slate-700">Left: <span id="score-left">0</span></div>
                </div>

                <div id="timer-bar">
                    <div id="timer-fill"></div>
                </div>

                <div class="display-box" id="problem-text">...</div>
                
                <input type="number" id="answer-input" class="input-box mb-6" placeholder="?" autocomplete="off" inputmode="numeric">

                <div class="flex space-x-3">
                    <button id="btn-submit" class="btn btn-primary flex-1">Check Answer</button>
                    <button id="btn-quit" class="btn bg-slate-200 text-slate-700 flex-1">Quit</button>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="hidden">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Test Complete!</h2>
                <div class="text-4xl font-extrabold text-indigo-600 mb-2" id="final-percentage">0%</div>
                <p class="text-slate-500 mb-6" id="final-stats">You got 0 out of 0 right.</p>
                <button id="btn-restart" class="btn btn-primary w-full">Try Again</button>
            </div>
        </div>
    </div>

    <script type="module">
        const state = {
            isRunning: false,
            problems: [],
            currentIndex: 0,
            correct: 0,
            wrong: 0,
            timerLimit: 10000, // 10 seconds
            timerRemaining: 10000,
            timerId: null,
            apiKey: "" 
        };

        const ui = {
            screens: {
                config: document.getElementById('config-screen'),
                test: document.getElementById('test-screen'),
                results: document.getElementById('results-screen')
            },
            startTable: document.getElementById('start-table'),
            endTable: document.getElementById('end-table'),
            problem: document.getElementById('problem-text'),
            input: document.getElementById('answer-input'),
            timerFill: document.getElementById('timer-fill'),
            scoreCorrect: document.getElementById('score-correct'),
            scoreWrong: document.getElementById('score-wrong'),
            scoreLeft: document.getElementById('score-left'),
            finalStats: document.getElementById('final-stats'),
            finalPercent: document.getElementById('final-percentage')
        };

        function init() {
            for (let i = 1; i <= 20; i++) {
                ui.startTable.add(new Option(i, i));
                ui.endTable.add(new Option(i, i));
            }
            ui.startTable.value = 1;
            ui.endTable.value = 10;

            document.getElementById('btn-start').addEventListener('click', startTest);
            document.getElementById('btn-quit').addEventListener('click', () => location.reload());
            document.getElementById('btn-restart').addEventListener('click', () => location.reload());
            document.getElementById('btn-submit').addEventListener('click', checkAnswer);
            
            ui.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });
        }

        async function speak(text) {
            const apiKey = state.apiKey;
            const payload = {
                contents: [{ parts: [{ text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                const audio64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audio64) return;
                const audio = new Audio(URL.createObjectURL(createWavBlob(Uint8Array.from(atob(audio64), c => c.charCodeAt(0)).buffer, 24000)));
                audio.play();
            } catch (e) { console.error(e); }
        }

        function createWavBlob(pcm, rate) {
            const h = new ArrayBuffer(44); const v = new DataView(h); const l = pcm.byteLength;
            const s = (o, str) => { for(let i=0; i<str.length; i++) v.setUint8(o+i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 36+l, true); s(8, 'WAVE'); s(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate*2, true); v.setUint16(32, 2, true);
            v.setUint16(34, 16, true); s(36, 'data'); v.setUint32(40, l, true);
            const b = new Uint8Array(44+l); b.set(new Uint8Array(h),0); b.set(new Uint8Array(pcm),44);
            return new Blob([b], {type:'audio/wav'});
        }

        function startTest() {
            const s = parseInt(ui.startTable.value);
            const e = parseInt(ui.endTable.value);
            if (s > e) return alert("Start must be <= End");

            state.problems = [];
            for (let t = s; t <= e; t++) {
                for (let m = 1; m <= 10; m++) state.problems.push({ t, m });
            }
            state.problems.sort(() => Math.random() - 0.5);
            
            state.correct = 0;
            state.wrong = 0;
            state.currentIndex = 0;
            state.isRunning = true;

            ui.screens.config.classList.add('hidden');
            ui.screens.test.classList.remove('hidden');
            
            nextProblem();
        }

        async function nextProblem() {
            if (state.currentIndex >= state.problems.length) return endTest();

            const p = state.problems[state.currentIndex];
            ui.problem.textContent = `${p.t} Ã— ${p.m}`;
            ui.input.value = "";
            ui.input.className = "input-box mb-6";
            ui.input.disabled = false;
            ui.input.focus();
            
            updateScoreboard();
            startTimer();
            await speak(`What is ${p.t} times ${p.m}?`);
        }

        function startTimer() {
            clearInterval(state.timerId);
            state.timerRemaining = state.timerLimit;
            state.timerId = setInterval(() => {
                state.timerRemaining -= 100;
                const percent = (state.timerRemaining / state.timerLimit) * 100;
                ui.timerFill.style.width = percent + "%";
                
                if (state.timerRemaining <= 0) {
                    clearInterval(state.timerId);
                    handleFail("Time's up!");
                }
            }, 100);
        }

        function updateScoreboard() {
            ui.scoreCorrect.textContent = state.correct;
            ui.scoreWrong.textContent = state.wrong;
            ui.scoreLeft.textContent = state.problems.length - state.currentIndex;
        }

        async function checkAnswer() {
            if (ui.input.disabled) return;
            
            clearInterval(state.timerId);
            const p = state.problems[state.currentIndex];
            const val = parseInt(ui.input.value);
            const correctVal = p.t * p.m;

            ui.input.disabled = true;

            if (val === correctVal) {
                state.correct++;
                ui.input.classList.add('correct');
                await speak("Correct!");
                setTimeout(moveToNext, 1000);
            } else {
                handleFail("Not quite.");
            }
        }

        async function handleFail(msg) {
            clearInterval(state.timerId);
            state.wrong++;
            const p = state.problems[state.currentIndex];
            ui.input.disabled = true;
            ui.input.classList.add('wrong');
            ui.input.value = p.t * p.m; // Show correct answer
            
            await speak(`${msg} ${p.t} times ${p.m} is ${p.t * p.m}`);
            setTimeout(moveToNext, 2500);
        }

        function moveToNext() {
            state.currentIndex++;
            nextProblem();
        }

        function endTest() {
            state.isRunning = false;
            ui.screens.test.classList.add('hidden');
            ui.screens.results.classList.remove('hidden');
            
            const total = state.problems.length;
            const percent = Math.round((state.correct / total) * 100);
            ui.finalPercent.textContent = percent + "%";
            ui.finalStats.textContent = `You got ${state.correct} out of ${total} right!`;
            speak(`Test complete. Your score is ${percent} percent.`);
        }

        init();
    </script>
</body>
</html>
